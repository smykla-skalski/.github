---
name: Sync Smyklot

on:
  push:
    branches: [main]
    paths:
      - "action.yml"
      - "smyklot-templates/**"
      - ".github/workflows/sync-smyklot.yml"
  repository_dispatch:
    types: [smyklot-release]
  workflow_dispatch:
    inputs:
      use_latest:
        description: "Fetch latest release automatically"
        required: false
        type: boolean
        default: true
      version:
        description: "Version (e.g., 1.9.2)"
        required: false
        type: string
      tag:
        description: "Tag (e.g., v1.9.2)"
        required: false
        type: string
      sha:
        description: "Commit SHA"
        required: false
        type: string
      dry_run:
        description: "Preview changes only"
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      repo:
        description: "Single repository to sync (optional, syncs all if not provided)"
        required: false
        type: string
        default: ""
      dry_run:
        description: "Preview changes only"
        required: false
        type: boolean
        default: false
    secrets:
      SMYKLOT_APP_PRIVATE_KEY:
        required: true

permissions: {}

jobs:
  validate:
    runs-on: ${{ fromJSON(vars.RUNNER_LABEL || '["ubuntu-24.04"]') }}
    steps:
      - name: Validate smyklot configuration
        env:
          SMYKLOT_APP_ID: ${{ vars.SMYKLOT_APP_ID }}
          SMYKLOT_APP_PRIVATE_KEY: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
        run: |
          errors=()

          if [[ -z "$SMYKLOT_APP_ID" ]]; then
            errors+=("SMYKLOT_APP_ID variable is not set")
          fi

          if [[ -z "$SMYKLOT_APP_PRIVATE_KEY" ]]; then
            errors+=("SMYKLOT_APP_PRIVATE_KEY secret is missing or empty")
          fi

          if [[ ${#errors[@]} -gt 0 ]]; then
            for error in "${errors[@]}"; do
              echo "::error::$error"
            done
            exit 1
          fi

          echo "âœ… Smyklot configuration validated"

  resolve-version:
    needs: validate
    runs-on: ${{ fromJSON(vars.RUNNER_LABEL || '["ubuntu-24.04"]') }}
    outputs:
      version: ${{ steps.resolve.outputs.version }}
      tag: ${{ steps.resolve.outputs.tag }}
      sha: ${{ steps.resolve.outputs.sha }}
    steps:
      - name: Resolve smyklot version
        id: resolve
        env:
          GH_TOKEN: ${{ github.token }}
          # repository_dispatch payload (from smyklot release workflow)
          PAYLOAD_VERSION: ${{ github.event.client_payload.version }}
          PAYLOAD_TAG: ${{ github.event.client_payload.tag }}
          PAYLOAD_SHA: ${{ github.event.client_payload.sha }}
          # workflow_dispatch inputs
          INPUT_USE_LATEST: ${{ inputs.use_latest }}
          INPUT_VERSION: ${{ inputs.version }}
          INPUT_TAG: ${{ inputs.tag }}
          INPUT_SHA: ${{ inputs.sha }}
        run: |
          # Priority:
          # 1. repository_dispatch payload (from smyklot release)
          # 2. workflow_dispatch with use_latest=false and manual values
          # 3. Fetch latest release (use_latest=true or no values provided)

          if [[ -n "$PAYLOAD_VERSION" && -n "$PAYLOAD_TAG" && -n "$PAYLOAD_SHA" ]]; then
            echo "Using repository_dispatch payload"
            {
              echo "version=$PAYLOAD_VERSION"
              echo "tag=$PAYLOAD_TAG"
              echo "sha=$PAYLOAD_SHA"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$INPUT_USE_LATEST" == "false" && -n "$INPUT_VERSION" && -n "$INPUT_TAG" && -n "$INPUT_SHA" ]]; then
            echo "Using manual workflow_dispatch inputs"
            {
              echo "version=$INPUT_VERSION"
              echo "tag=$INPUT_TAG"
              echo "sha=$INPUT_SHA"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Fetching latest smyklot release..."
          TAG=$(gh api repos/smykla-skalski/smyklot/releases/latest --jq '.tag_name')
          VERSION="${TAG#v}"
          SHA=$(gh api "repos/smykla-skalski/smyklot/git/ref/tags/${TAG}" --jq '.object.sha')

          echo "Resolved: version=$VERSION, tag=$TAG, sha=$SHA"
          {
            echo "version=$VERSION"
            echo "tag=$TAG"
            echo "sha=$SHA"
          } >> "$GITHUB_OUTPUT"

  get-repos:
    needs: [validate, resolve-version]
    runs-on: ${{ fromJSON(vars.RUNNER_LABEL || '["ubuntu-24.04"]') }}
    outputs:
      repos: ${{ steps.repos.outputs.repos }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Generate App Token
        id: token
        if: inputs.repo == ''
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Get repositories
        id: repos
        uses: ./.github/actions/get-repos
        with:
          repo: ${{ inputs.repo }}
          token: ${{ steps.token.outputs.token }}

  sync-smyklot:
    needs: [resolve-version, get-repos]
    runs-on: ${{ fromJSON(vars.RUNNER_LABEL || '["ubuntu-24.04"]') }}
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.get-repos.outputs.repos) }}
    concurrency:
      group: sync-smyklot-${{ matrix.repo.name }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Generate App Token
        id: token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ matrix.repo.name }}

      - name: Sync Smyklot
        uses: ./
        with:
          command: smyklot
          subcommand: sync
          token: ${{ steps.token.outputs.token }}
          repo: ${{ matrix.repo.name }}
          version: ${{ needs.resolve-version.outputs.version }}
          tag: ${{ needs.resolve-version.outputs.tag }}
          sha: ${{ needs.resolve-version.outputs.sha }}
          smyklot_file: .github/smyklot.yml
          smyklot_templates_dir: smyklot-templates
          dry_run: ${{ inputs.dry_run || 'false' }}
          result_file: smyklot-result-${{ matrix.repo.name }}.json

      - name: Upload result artifact
        if: always()
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: smyklot-result-${{ matrix.repo.name }}
          path: smyklot-result-${{ matrix.repo.name }}.json
          retention-days: 1

  summary:
    needs: sync-smyklot
    if: always()
    runs-on: ${{ fromJSON(vars.RUNNER_LABEL || '["ubuntu-24.04"]') }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download all result artifacts
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          pattern: smyklot-result-*
          path: results

      - name: Flatten results directory
        run: mv results/smyklot-result-*/smyklot-result-*.json results/ 2>/dev/null || true

      - name: Generate markdown summary
        uses: ./
        with:
          command: summary
          subcommand: generate
          type: smyklot
          results_dir: results
          format: markdown
          dry_run: ${{ inputs.dry_run || 'false' }}

      - name: Generate workflow summary JSON
        uses: ./
        with:
          command: summary
          subcommand: generate
          type: smyklot
          results_dir: results
          format: json
          output: summary-smyklot.json
          dry_run: ${{ inputs.dry_run || 'false' }}

      - name: Upload workflow summary artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: workflow-summary-smyklot
          path: summary-smyklot.json
          retention-days: 7
