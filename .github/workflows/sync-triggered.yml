---
name: Sync Triggered

on:
  repository_dispatch:
    types: [sync-trigger]

permissions: {}

concurrency:
  group: sync-triggered-${{ github.event.client_payload.repo || format('unknown-{0}', github.run_id) }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ${{ fromJSON(vars.RUNNER_LABEL || '["ubuntu-24.04"]') }}
    outputs:
      repo: ${{ steps.validate.outputs.repo }}
      sync_labels: ${{ steps.validate.outputs.sync_labels }}
      sync_files: ${{ steps.validate.outputs.sync_files }}
      sync_settings: ${{ steps.validate.outputs.sync_settings }}
      sync_smyklot: ${{ steps.validate.outputs.sync_smyklot }}
    steps:
      - name: Validate payload
        id: validate
        env:
          PAYLOAD_REPO: ${{ github.event.client_payload.repo }}
          PAYLOAD_FULL_NAME: ${{ github.event.client_payload.full_name }}
          PAYLOAD_TRIGGER: ${{ github.event.client_payload.trigger }}
          PAYLOAD_SYNC_LABELS: ${{ github.event.client_payload.sync_labels }}
          PAYLOAD_SYNC_FILES: ${{ github.event.client_payload.sync_files }}
          PAYLOAD_SYNC_SETTINGS: ${{ github.event.client_payload.sync_settings }}
          PAYLOAD_SYNC_SMYKLOT: ${{ github.event.client_payload.sync_smyklot }}
        run: |
          echo "Received dispatch from: $PAYLOAD_FULL_NAME"
          echo "Trigger type: $PAYLOAD_TRIGGER"

          # Validate required fields
          if [[ -z "$PAYLOAD_REPO" ]]; then
            echo "::error::Missing required field: repo"
            exit 1
          fi

          # Validate repository name format (defense in depth)
          if [[ ! "$PAYLOAD_REPO" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "::error::Invalid repository name format"
            exit 1
          fi

          # Reject excluded repos
          if [[ "$PAYLOAD_REPO" == ".github" || "$PAYLOAD_REPO" == "smyklot" ]]; then
            echo "::error::Repository '$PAYLOAD_REPO' is excluded from sync"
            exit 1
          fi

          # Output validated values
          {
            echo "repo=$PAYLOAD_REPO"
            echo "sync_labels=$PAYLOAD_SYNC_LABELS"
            echo "sync_files=$PAYLOAD_SYNC_FILES"
            echo "sync_settings=$PAYLOAD_SYNC_SETTINGS"
            echo "sync_smyklot=$PAYLOAD_SYNC_SMYKLOT"
          } >> "$GITHUB_OUTPUT"

          {
            echo "### Sync Triggered"
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| Repository | \`$PAYLOAD_REPO\` |"
            echo "| Trigger | $PAYLOAD_TRIGGER |"
            echo "| Sync Labels | $PAYLOAD_SYNC_LABELS |"
            echo "| Sync Files | $PAYLOAD_SYNC_FILES |"
            echo "| Sync Settings | $PAYLOAD_SYNC_SETTINGS |"
            echo "| Sync Smyklot | $PAYLOAD_SYNC_SMYKLOT |"
          } >> "$GITHUB_STEP_SUMMARY"

  sync-labels:
    needs: validate
    if: needs.validate.outputs.sync_labels == 'true'
    uses: ./.github/workflows/sync-labels.yml
    with:
      repo: ${{ needs.validate.outputs.repo }}
    secrets:
      SMYKLOT_APP_PRIVATE_KEY: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}

  sync-files:
    needs: validate
    if: needs.validate.outputs.sync_files == 'true'
    uses: ./.github/workflows/sync-files.yml
    with:
      repo: ${{ needs.validate.outputs.repo }}
    secrets:
      SMYKLOT_APP_PRIVATE_KEY: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}

  sync-settings:
    needs: validate
    if: needs.validate.outputs.sync_settings == 'true'
    uses: ./.github/workflows/sync-settings.yml
    with:
      repo: ${{ needs.validate.outputs.repo }}
    secrets:
      SMYKLOT_APP_PRIVATE_KEY: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}

  sync-smyklot:
    needs: validate
    if: needs.validate.outputs.sync_smyklot == 'true'
    uses: ./.github/workflows/sync-smyklot.yml
    with:
      repo: ${{ needs.validate.outputs.repo }}
    secrets:
      SMYKLOT_APP_PRIVATE_KEY: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}

  summary:
    needs: [validate, sync-labels, sync-files, sync-settings, sync-smyklot]
    if: always() && needs.validate.result == 'success'
    runs-on: ${{ fromJSON(vars.RUNNER_LABEL || '["ubuntu-24.04"]') }}
    steps:
      - name: Generate summary
        env:
          REPO: ${{ needs.validate.outputs.repo }}
          LABELS_RESULT: ${{ needs.sync-labels.result }}
          FILES_RESULT: ${{ needs.sync-files.result }}
          SETTINGS_RESULT: ${{ needs.sync-settings.result }}
          SMYKLOT_RESULT: ${{ needs.sync-smyklot.result }}
        run: |
          status_icon() {
            case "$1" in
              success) echo "âœ…" ;;
              failure) echo "âŒ" ;;
              skipped) echo "â­ï¸" ;;
              cancelled) echo "ðŸš«" ;;
              *) echo "â“" ;;
            esac
          }

          {
            echo "### Sync Summary for \`$REPO\`"
            echo ""
            echo "| Sync Type | Status |"
            echo "|-----------|--------|"
            echo "| Labels | $(status_icon "$LABELS_RESULT") $LABELS_RESULT |"
            echo "| Files | $(status_icon "$FILES_RESULT") $FILES_RESULT |"
            echo "| Settings | $(status_icon "$SETTINGS_RESULT") $SETTINGS_RESULT |"
            echo "| Smyklot | $(status_icon "$SMYKLOT_RESULT") $SMYKLOT_RESULT |"
          } >> "$GITHUB_STEP_SUMMARY"
