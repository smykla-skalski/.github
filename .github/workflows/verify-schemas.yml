---
name: Verify Schemas

on:
  pull_request:
    paths:
      - "go.mod"
      - "go.sum"
      - "pkg/config/**"
      - "pkg/github/**"
      - "pkg/schema/**"
      - "cmd/schemagen/**"
      - "schemas/*.schema.json"
      - "internal/configtypes/**"
      - ".github/workflows/verify-schemas.yml"

# Prevent infinite loops: cancel in-progress runs when new commits arrive
# Note: matrix context is not available at workflow level, but this is intentional -
# we want all matrix jobs cancelled together when a new commit arrives
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  verify-schemas:
    runs-on: ${{ fromJSON(vars.RUNNER_LABEL || '["ubuntu-24.04"]') }}
    # Only run for PRs from the same repository (not forks)
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.head_ref }}
          token: ${{ steps.generate-token.outputs.token }}

      - name: Check for bot commit
        id: check-bot
        run: |
          AUTHOR=$(git log -1 --format='%an')
          if [[ "$AUTHOR" == *"smyklot"* ]] || [[ "$AUTHOR" == *"[bot]"* ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "â­ï¸ Skipping: last commit was from bot ($AUTHOR)"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Go
        if: steps.check-bot.outputs.skip != 'true'
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Setup mise
        if: steps.check-bot.outputs.skip != 'true'
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          install_args: jsonschema

      - name: Regenerate all schemas
        if: steps.check-bot.outputs.skip != 'true'
        run: |
          go run ./cmd/schemagen --all --output-dir schemas
          jsonschema fmt schemas/*.schema.json

      - name: Lint schemas
        if: steps.check-bot.outputs.skip != 'true'
        run: jsonschema lint --strict schemas/*.schema.json

      - name: Check for schema changes
        if: steps.check-bot.outputs.skip != 'true'
        id: check-changes
        run: |
          if git diff --quiet schemas/; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "âœ… All schemas are up to date"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ“ Schema changes detected:"
            git diff --stat schemas/
          fi

      - name: Commit schema changes
        if: steps.check-bot.outputs.skip != 'true' && steps.check-changes.outputs.has_changes == 'true'
        env:
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.head_ref }}
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          # Read changed schema files into array (handles spaces/special chars)
          mapfile -t changed_files < <(git diff --name-only -- schemas/)

          if [[ ${#changed_files[@]} -eq 0 ]]; then
            echo "No schema files changed"
            exit 0
          fi

          # Get latest commit and tree from remote
          latest_sha=$(gh api "repos/${REPO}/git/ref/heads/${BRANCH}" --jq '.object.sha')
          base_tree=$(gh api "repos/${REPO}/git/commits/${latest_sha}" --jq '.tree.sha')

          # Build tree entries array using jq for proper JSON construction
          tree_entries="[]"
          for file in "${changed_files[@]}"; do
            [[ -f "$file" ]] || continue

            # Create blob via API
            blob_sha=$(gh api "repos/${REPO}/git/blobs" \
              --field content="$(base64 --wrap=0 < "$file")" \
              --field encoding="base64" \
              --jq '.sha')

            # Append entry using jq (safe JSON construction)
            tree_entries=$(printf '%s' "$tree_entries" | jq --compact-output \
              --arg path "$file" \
              --arg sha "$blob_sha" \
              '. + [{"path": $path, "mode": "100644", "type": "blob", "sha": $sha}]')
          done

          # Create tree
          new_tree=$(jq -n --arg base "$base_tree" --argjson tree "$tree_entries" \
            '{"base_tree": $base, "tree": $tree}' | \
            gh api "repos/${REPO}/git/trees" --input - --jq '.sha')

          # Create signed commit via API
          commit_msg="chore(schema): regenerate schemas"
          commit_msg+=$'\n\n'"Schemas were out of sync with Go types. Regenerated all schemas."

          new_commit=$(gh api "repos/${REPO}/git/commits" \
            --field message="$commit_msg" \
            --field tree="$new_tree" \
            --raw-field "parents[]=${latest_sha}" \
            --jq '.sha')

          # Update branch reference
          gh api --method PATCH "repos/${REPO}/git/refs/heads/${BRANCH}" --field sha="$new_commit"

          echo "âœ… Created verified commit: $new_commit"
