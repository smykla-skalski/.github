---
# Reusable test workflow for Go projects
# Usage:
#   jobs:
#     test:
#       uses: smykla-labs/.github/.github/workflows/lib-test.yml@<commit-sha> # v1.0.0
#       with:
#         go-version: "1.23.x"
# Note: Pin to commit SHA with semver comment. Get SHA: git rev-parse v1.0.0

name: Test

on:
  workflow_call:
    inputs:
      go-version:
        description: "Go version to use (comma-separated for matrix)"
        required: false
        type: string
        default: "1.23.x"
      test-flags:
        description: "Additional go test flags"
        required: false
        type: string
        default: "-v -race"
      coverage-threshold:
        description: "Minimum coverage percentage (0-100, 0 to disable)"
        required: false
        type: number
        default: 0
      test-timeout:
        description: "Test timeout duration"
        required: false
        type: string
        default: "10m"
    outputs:
      coverage-percent:
        description: "Code coverage percentage"
        value: ${{ jobs.test.outputs.coverage }}

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-24.04
    outputs:
      coverage: ${{ steps.coverage.outputs.percent }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Run tests
        env:
          TEST_FLAGS: ${{ inputs.test-flags }}
          TEST_TIMEOUT: ${{ inputs.test-timeout }}
        run: |
          go test $TEST_FLAGS -timeout "$TEST_TIMEOUT" -coverprofile=coverage.out ./...

      - name: Calculate coverage
        id: coverage
        run: |
          if [ -f coverage.out ]; then
            coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
            echo "percent=$coverage" >> "$GITHUB_OUTPUT"
            echo "Coverage: ${coverage}%"
          else
            echo "percent=0" >> "$GITHUB_OUTPUT"
            echo "No coverage data"
          fi

      - name: Check coverage threshold
        if: inputs.coverage-threshold > 0
        env:
          THRESHOLD: ${{ inputs.coverage-threshold }}
          COVERAGE: ${{ steps.coverage.outputs.percent }}
        run: |
          if [ "$(echo "$COVERAGE < $THRESHOLD" | bc -l)" -eq 1 ]; then
            echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi
          echo "Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"

      - name: Upload coverage
        if: always() && hashFiles('coverage.out') != ''
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-${{ github.sha }}
          path: coverage.out
          retention-days: 7
