---
# Reusable test workflow for Go projects
# Usage:
#   jobs:
#     test:
#       uses: smykla-skalski/.github/.github/workflows/lib-test.yml@<commit-sha> # v1.0.0
#       with:
#         go-version: "1.25.x"
# Note: Pin to commit SHA with semver comment. Get SHA: git rev-parse v1.0.0

name: Test

on:
  workflow_call:
    inputs:
      go-version:
        description: "Go version to use (comma-separated for matrix)"
        required: false
        type: string
        default: "1.25.x"
      test-flags:
        description: "Additional go test flags"
        required: false
        type: string
        default: "-v -race"
      coverage-threshold:
        description: "Minimum coverage percentage (0-100, 0 to disable)"
        required: false
        type: number
        default: 0
      test-timeout:
        description: "Test timeout duration"
        required: false
        type: string
        default: "10m"
      skip-all:
        description: "Skip all checks (ci/skip-all label)"
        required: false
        type: boolean
        default: false
      skip-tests:
        description: "Skip test checks (ci/skip-tests label)"
        required: false
        type: boolean
        default: false
    outputs:
      coverage-percent:
        description: "Code coverage percentage"
        value: ${{ jobs.test.outputs.coverage }}

permissions:
  contents: read

jobs:
  test:
    if: "!inputs.skip-all && !inputs.skip-tests"
    runs-on: ubuntu-24.04
    outputs:
      coverage: ${{ steps.coverage.outputs.percent }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Run tests
        env:
          TEST_FLAGS: ${{ inputs.test-flags }}
          TEST_TIMEOUT: ${{ inputs.test-timeout }}
        run: |
          go test $TEST_FLAGS -timeout "$TEST_TIMEOUT" -coverprofile=coverage.out ./...

      - name: Calculate coverage
        id: coverage
        run: |
          if [ -f coverage.out ]; then
            coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
            echo "percent=$coverage" >> "$GITHUB_OUTPUT"
            echo "Coverage: ${coverage}%"
          else
            echo "percent=0" >> "$GITHUB_OUTPUT"
            echo "No coverage data"
          fi

      - name: Check coverage threshold
        if: inputs.coverage-threshold > 0
        env:
          THRESHOLD: ${{ inputs.coverage-threshold }}
          COVERAGE: ${{ steps.coverage.outputs.percent }}
        run: |
          if [ "$(echo "$COVERAGE < $THRESHOLD" | bc -l)" -eq 1 ]; then
            echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi
          echo "Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"

      - name: Upload coverage
        if: always() && hashFiles('coverage.out') != ''
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: coverage-${{ github.sha }}
          path: coverage.out
          retention-days: 7
