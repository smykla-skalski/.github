---
# Reusable build workflow for Go projects
# Usage:
#   jobs:
#     build:
#       uses: smykla-labs/.github/.github/workflows/lib-build.yml@<commit-sha> # v1.0.0
#       with:
#         go-version: "1.25.x"
# Note: Pin to commit SHA with semver comment. Get SHA: git rev-parse v1.0.0

name: Build

on:
  workflow_call:
    inputs:
      go-version:
        description: "Go version to use"
        required: false
        type: string
        default: "1.25.x"
      build-targets:
        description: "OS/arch targets (JSON array)"
        required: false
        type: string
        default: '["linux/amd64"]'
      artifact-name:
        description: "Name for uploaded artifact"
        required: false
        type: string
        default: "binaries"
      binary-name:
        description: "Output binary name (defaults to repo name)"
        required: false
        type: string
        default: ""
      ldflags:
        description: "Linker flags for go build"
        required: false
        type: string
        default: "-s -w"
      skip-all:
        description: "Skip all checks (ci/skip-all label)"
        required: false
        type: boolean
        default: false
      skip-build:
        description: "Skip build checks (ci/skip-build label)"
        required: false
        type: boolean
        default: false
    outputs:
      artifact-name:
        description: "Name of uploaded artifact"
        value: ${{ jobs.build.outputs.artifact-name }}

permissions:
  contents: read

jobs:
  build:
    if: "!inputs.skip-all && !inputs.skip-build"
    runs-on: ubuntu-24.04
    outputs:
      artifact-name: ${{ inputs.artifact-name }}
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJson(inputs.build-targets) }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Parse target
        id: target
        env:
          TARGET: ${{ matrix.target }}
        run: |
          os=$(echo "$TARGET" | cut -d'/' -f1)
          arch=$(echo "$TARGET" | cut -d'/' -f2)
          echo "os=$os" >> "$GITHUB_OUTPUT"
          echo "arch=$arch" >> "$GITHUB_OUTPUT"
          echo "Building for $os/$arch"

      - name: Build
        env:
          GOOS: ${{ steps.target.outputs.os }}
          GOARCH: ${{ steps.target.outputs.arch }}
          CGO_ENABLED: "0"
          LDFLAGS: ${{ inputs.ldflags }}
          BINARY_NAME: ${{ inputs.binary-name || github.event.repository.name }}
        run: |
          output_name="${BINARY_NAME}-${GOOS}-${GOARCH}"
          [ "$GOOS" = "windows" ] && output_name="${output_name}.exe"

          echo "Building $output_name"
          go build -ldflags "$LDFLAGS" -o "dist/$output_name" .

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ inputs.artifact-name }}-${{ steps.target.outputs.os }}-${{ steps.target.outputs.arch }}
          path: dist/
          retention-days: 7
