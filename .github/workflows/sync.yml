---
name: Sync All

on:
  workflow_dispatch:
    inputs:
      sync_labels:
        description: "Sync labels"
        required: false
        type: boolean
        default: true
      sync_files:
        description: "Sync files"
        required: false
        type: boolean
        default: true
      sync_settings:
        description: "Sync settings"
        required: false
        type: boolean
        default: true
      sync_smyklot:
        description: "Sync smyklot"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "Dry run (no changes)"
        required: false
        type: boolean
        default: false

permissions: {}

jobs:
  trigger-syncs:
    runs-on: ubuntu-24.04
    outputs:
      triggered_runs: ${{ steps.trigger.outputs.runs }}
    steps:
      - name: Generate App Token
        id: token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: .github

      - name: Trigger sync workflows
        id: trigger
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO: ${{ github.repository }}
          SYNC_LABELS: ${{ inputs.sync_labels }}
          SYNC_FILES: ${{ inputs.sync_files }}
          SYNC_SETTINGS: ${{ inputs.sync_settings }}
          SYNC_SMYKLOT: ${{ inputs.sync_smyklot }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "## ðŸ”„ Triggering Sync Workflows" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          triggered_runs=""

          if [[ "$SYNC_LABELS" == "true" ]]; then
            echo "Triggering Sync Labels..."
            gh workflow run sync-labels.yml --repo "$REPO" -f "dry_run=$DRY_RUN"
            sleep 2
            run_id=$(gh run list --workflow=sync-labels.yml --repo "$REPO" --limit 1 --json databaseId --jq '.[0].databaseId')
            triggered_runs="${triggered_runs}labels:${run_id} "
            echo "- âœ… Sync Labels triggered (run: $run_id)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- â­ï¸ Sync Labels skipped" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "$SYNC_FILES" == "true" ]]; then
            echo "Triggering Sync Files..."
            gh workflow run sync-files.yml --repo "$REPO" -f "dry_run=$DRY_RUN"
            sleep 2
            run_id=$(gh run list --workflow=sync-files.yml --repo "$REPO" --limit 1 --json databaseId --jq '.[0].databaseId')
            triggered_runs="${triggered_runs}files:${run_id} "
            echo "- âœ… Sync Files triggered (run: $run_id)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- â­ï¸ Sync Files skipped" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "$SYNC_SETTINGS" == "true" ]]; then
            echo "Triggering Sync Settings..."
            gh workflow run sync-settings.yml --repo "$REPO" -f "dry_run=$DRY_RUN"
            sleep 2
            run_id=$(gh run list --workflow=sync-settings.yml --repo "$REPO" --limit 1 --json databaseId --jq '.[0].databaseId')
            triggered_runs="${triggered_runs}settings:${run_id} "
            echo "- âœ… Sync Settings triggered (run: $run_id)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- â­ï¸ Sync Settings skipped" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "$SYNC_SMYKLOT" == "true" ]]; then
            echo "Triggering Sync Smyklot..."
            gh workflow run sync-smyklot.yml --repo "$REPO" -f "use_latest=true" -f "dry_run=$DRY_RUN"
            sleep 2
            run_id=$(gh run list --workflow=sync-smyklot.yml --repo "$REPO" --limit 1 --json databaseId --jq '.[0].databaseId')
            triggered_runs="${triggered_runs}smyklot:${run_id} "
            echo "- âœ… Sync Smyklot triggered (run: $run_id)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- â­ï¸ Sync Smyklot skipped" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "â„¹ï¸ **Dry run mode** - no changes will be made" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "runs=${triggered_runs% }" >> "$GITHUB_OUTPUT"

  wait-and-summarize:
    runs-on: ubuntu-24.04
    needs: trigger-syncs
    if: needs.trigger-syncs.outputs.triggered_runs != ''
    steps:
      - name: Generate App Token
        id: token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: .github

      - name: Wait for workflows to complete
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO: ${{ github.repository }}
          TRIGGERED_RUNS: ${{ needs.trigger-syncs.outputs.triggered_runs }}
        run: |
          echo "## â³ Waiting for Workflows" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          for run_info in $TRIGGERED_RUNS; do
            type="${run_info%%:*}"
            run_id="${run_info##*:}"
            echo "Waiting for $type sync (run: $run_id)..."
            gh run watch "$run_id" --repo "$REPO" || true
            echo "- âœ… $type sync completed" >> "$GITHUB_STEP_SUMMARY"
          done

      - name: Download workflow summaries
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO: ${{ github.repository }}
          TRIGGERED_RUNS: ${{ needs.trigger-syncs.outputs.triggered_runs }}
        run: |
          mkdir -p workflow-summaries

          for run_info in $TRIGGERED_RUNS; do
            type="${run_info%%:*}"
            run_id="${run_info##*:}"
            echo "Downloading workflow summary for $type (run: $run_id)..."
            gh run download "$run_id" --repo "$REPO" --name "workflow-summary-$type" --dir workflow-summaries/ || echo "Warning: No summary artifact for $type"
          done

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Generate consolidated summary
        uses: ./
        with:
          command: summary
          subcommand: generate
          token: ${{ steps.token.outputs.token }}
          type: all
          results_dir: workflow-summaries
          dry_run: ${{ inputs.dry_run }}
