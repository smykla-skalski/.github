---
name: Sync All

on:
  workflow_dispatch:
    inputs:
      sync_labels:
        description: "Sync labels"
        required: false
        type: boolean
        default: true
      sync_files:
        description: "Sync files"
        required: false
        type: boolean
        default: true
      sync_settings:
        description: "Sync settings"
        required: false
        type: boolean
        default: true
      sync_smyklot:
        description: "Sync smyklot"
        required: false
        type: boolean
        default: true
      dry_run:
        description: "Dry run (no changes)"
        required: false
        type: boolean
        default: false

permissions: {}

jobs:
  trigger-syncs:
    runs-on: ubuntu-24.04
    outputs:
      triggered_runs: ${{ steps.trigger.outputs.runs }}
      disabled_count: ${{ steps.trigger.outputs.disabled_count }}
      skipped_count: ${{ steps.trigger.outputs.skipped_count }}
      dry_run: ${{ steps.trigger.outputs.dry_run }}
    steps:
      - name: Generate App Token
        id: token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: .github

      - name: Trigger sync workflows
        id: trigger
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO: ${{ github.repository }}
          SYNC_LABELS: ${{ inputs.sync_labels }}
          SYNC_FILES: ${{ inputs.sync_files }}
          SYNC_SETTINGS: ${{ inputs.sync_settings }}
          SYNC_SMYKLOT: ${{ inputs.sync_smyklot }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          triggered_runs=""
          disabled_count=0
          skipped_count=0

          # Helper function to check if workflow is enabled
          is_workflow_enabled() {
            local workflow_file="$1"
            local state
            state=$(gh api "repos/$REPO/actions/workflows/$workflow_file" --jq '.state')
            [[ "$state" == "active" ]]
          }

          # Helper function to trigger workflow
          trigger_workflow() {
            local name="$1"
            local workflow_file="$2"
            local type="$3"
            local should_sync="$4"
            shift 4
            local extra_args=("$@")

            if [[ "$should_sync" != "true" ]]; then
              echo "$name: skipped (disabled by user)"
              ((skipped_count++))
              return
            fi

            if ! is_workflow_enabled "$workflow_file"; then
              echo "$name: skipped (workflow disabled)"
              ((disabled_count++))
              return
            fi

            echo "Triggering $name..."
            gh workflow run "$workflow_file" --repo "$REPO" -f "dry_run=$DRY_RUN" "${extra_args[@]}"
            sleep 2
            run_id=$(gh run list --workflow="$workflow_file" --repo "$REPO" --limit 1 --json databaseId --jq '.[0].databaseId')
            triggered_runs="${triggered_runs}${type}:${run_id}:${name} "
            echo "$name: triggered (run: $run_id)"
          }

          # Trigger each workflow
          trigger_workflow "Sync Labels" "sync-labels.yml" "labels" "$SYNC_LABELS"
          trigger_workflow "Sync Files" "sync-files.yml" "files" "$SYNC_FILES"
          trigger_workflow "Sync Settings" "sync-settings.yml" "settings" "$SYNC_SETTINGS"
          trigger_workflow "Sync Smyklot" "sync-smyklot.yml" "smyklot" "$SYNC_SMYKLOT" -f "use_latest=true"

          # Output results (no step summary - done in wait-and-summarize)
          echo "runs=${triggered_runs% }" >> "$GITHUB_OUTPUT"
          echo "disabled_count=$disabled_count" >> "$GITHUB_OUTPUT"
          echo "skipped_count=$skipped_count" >> "$GITHUB_OUTPUT"
          echo "dry_run=$DRY_RUN" >> "$GITHUB_OUTPUT"

  wait-and-summarize:
    runs-on: ubuntu-24.04
    needs: trigger-syncs
    if: needs.trigger-syncs.outputs.triggered_runs != ''
    steps:
      - name: Generate App Token
        id: token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: .github

      - name: Show triggered workflows and wait
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO: ${{ github.repository }}
          TRIGGERED_RUNS: ${{ needs.trigger-syncs.outputs.triggered_runs }}
          DISABLED_COUNT: ${{ needs.trigger-syncs.outputs.disabled_count }}
          DRY_RUN: ${{ needs.trigger-syncs.outputs.dry_run }}
        run: |
          {
            echo "# üîÑ Sync All - Workflow Status"
            echo ""
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "‚ö†Ô∏è **DRY RUN MODE** - No changes were applied"
              echo ""
            fi
            echo "## Triggered Workflows"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # Show triggered workflows with links
          for run_info in $TRIGGERED_RUNS; do
            IFS=':' read -r type run_id name <<< "$run_info"
            url="https://github.com/$REPO/actions/runs/$run_id"
            echo "- ‚è≥ **$name**: [View Run]($url)" >> "$GITHUB_STEP_SUMMARY"
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [[ "$DISABLED_COUNT" -gt 0 ]]; then
            echo "‚ö†Ô∏è **Warning**: $DISABLED_COUNT workflow(s) skipped (disabled, likely release in progress)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Wait for all workflows in parallel using background processes
          wait_for_run() {
            local run_id="$1"
            local name="$2"
            local max_wait=1800  # 30 minutes max
            local elapsed=0
            echo "Waiting for $name (run: $run_id)..."

            while [ $elapsed -lt $max_wait ]; do
              status=$(gh api "repos/$REPO/actions/runs/$run_id" --jq '.status' 2>&1)
              api_exit=$?

              if [ $api_exit -ne 0 ]; then
                echo "$name: API call failed (exit $api_exit), retrying..."
                sleep 5
                elapsed=$((elapsed + 5))
                continue
              fi

              if [[ "$status" == "completed" ]]; then
                conclusion=$(gh api "repos/$REPO/actions/runs/$run_id" --jq '.conclusion')
                echo "$name: ‚úÖ completed ($conclusion)"
                return 0
              fi

              # Show status every 30 seconds for visibility
              if [ $((elapsed % 30)) -eq 0 ]; then
                echo "$name: still waiting, status=$status (${elapsed}s elapsed)"
              fi

              sleep 10
              elapsed=$((elapsed + 10))
            done

            echo "$name: ‚ö†Ô∏è timeout after ${max_wait}s, last status=$status"
            return 1
          }

          # Start all wait processes in background
          pids=()
          for run_info in $TRIGGERED_RUNS; do
            IFS=':' read -r type run_id name <<< "$run_info"
            wait_for_run "$run_id" "$name" &
            pids+=($!)
          done

          # Wait for all background processes
          echo "Waiting for ${#pids[@]} workflows to complete..."
          for pid in "${pids[@]}"; do
            wait "$pid"
          done

          echo "All workflows completed!"

      - name: Download workflow summaries
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO: ${{ github.repository }}
          TRIGGERED_RUNS: ${{ needs.trigger-syncs.outputs.triggered_runs }}
        run: |
          mkdir -p workflow-summaries

          for run_info in $TRIGGERED_RUNS; do
            IFS=':' read -r type run_id name <<< "$run_info"
            echo "Downloading summary for $name (run: $run_id)..."
            gh run download "$run_id" --repo "$REPO" --name "workflow-summary-$type" --dir workflow-summaries/ || echo "Warning: No summary artifact for $name"
          done

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Generate consolidated summary
        uses: ./
        with:
          command: summary
          subcommand: generate
          token: ${{ steps.token.outputs.token }}
          type: all
          results_dir: workflow-summaries
          dry_run: ${{ needs.trigger-syncs.outputs.dry_run }}
