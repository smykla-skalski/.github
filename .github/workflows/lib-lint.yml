---
# Reusable lint workflow for Go projects
# Usage:
#   jobs:
#     lint:
#       uses: smykla-skalski/.github/.github/workflows/lib-lint.yml@<commit-sha> # v1.0.0
#       with:
#         go-version: "1.25.x"
# Note: Pin to commit SHA with semver comment. Get SHA: git rev-parse v1.0.0

name: Lint

on:
  workflow_call:
    inputs:
      go-version:
        description: "Go version to use"
        required: false
        type: string
        default: "1.25.x"
      enable-golangci-lint:
        description: "Enable golangci-lint"
        required: false
        type: boolean
        default: true
      enable-yamllint:
        description: "Enable yamllint"
        required: false
        type: boolean
        default: false
      enable-shellcheck:
        description: "Enable shellcheck"
        required: false
        type: boolean
        default: false
      enable-markdownlint:
        description: "Enable markdownlint"
        required: false
        type: boolean
        default: false
      golangci-lint-args:
        description: "Additional golangci-lint arguments"
        required: false
        type: string
        default: ""
      skip-all:
        description: "Skip all checks (ci/skip-all label)"
        required: false
        type: boolean
        default: false
      skip-lint:
        description: "Skip lint checks (ci/skip-lint label)"
        required: false
        type: boolean
        default: false
    outputs:
      lint-passed:
        description: "Whether all enabled linters passed"
        value: ${{ jobs.aggregate.outputs.passed }}

permissions:
  contents: read

jobs:
  golangci-lint:
    if: inputs.enable-golangci-lint && !inputs.skip-all && !inputs.skip-lint
    runs-on: ubuntu-24.04
    outputs:
      passed: ${{ steps.lint.outcome == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Run golangci-lint
        id: lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
        with:
          version: latest
          args: ${{ inputs.golangci-lint-args }}

  yamllint:
    if: inputs.enable-yamllint && !inputs.skip-all && !inputs.skip-lint
    runs-on: ubuntu-24.04
    outputs:
      passed: ${{ steps.lint.outcome == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run yamllint
        id: lint
        run: |
          pip install --quiet yamllint
          yamllint .

  shellcheck:
    if: inputs.enable-shellcheck && !inputs.skip-all && !inputs.skip-lint
    runs-on: ubuntu-24.04
    outputs:
      passed: ${{ steps.lint.outcome == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run shellcheck
        id: lint
        run: |
          find . -name "*.sh" -type f -print0 | xargs -0 shellcheck

  markdownlint:
    if: inputs.enable-markdownlint && !inputs.skip-all && !inputs.skip-lint
    runs-on: ubuntu-24.04
    outputs:
      passed: ${{ steps.lint.outcome == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run markdownlint
        id: lint
        run: |
          npm install -g markdownlint-cli
          markdownlint '**/*.md' --ignore node_modules

  aggregate:
    runs-on: ubuntu-24.04
    needs: [golangci-lint, yamllint, shellcheck, markdownlint]
    if: always()
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - name: Check results
        id: check
        env:
          GOLANGCI_RESULT: ${{ needs.golangci-lint.result }}
          YAMLLINT_RESULT: ${{ needs.yamllint.result }}
          SHELLCHECK_RESULT: ${{ needs.shellcheck.result }}
          MARKDOWNLINT_RESULT: ${{ needs.markdownlint.result }}
        run: |
          passed=true

          for result in "$GOLANGCI_RESULT" "$YAMLLINT_RESULT" "$SHELLCHECK_RESULT" "$MARKDOWNLINT_RESULT"; do
            if [ "$result" = "failure" ]; then
              passed=false
              break
            fi
          done

          echo "passed=$passed" >> "$GITHUB_OUTPUT"

          if [ "$passed" = "false" ]; then
            echo "::error::One or more linters failed"
            exit 1
          fi
