---
# Organization-wide Repository Settings
# ======================================
# These settings are synced to all smykla-labs repositories via dotsync.
# Individual repos can opt out or customize via .github/sync-config.yml
#
# See: https://github.com/smykla-labs/.github/blob/main/examples/sync-config.yml

settings:
  # Repository Settings
  # -------------------
  # Controls merge strategies and branch cleanup behavior
  repository:
    allow_squash_merge: true                             # Enable squash merge (recommended for clean history)
    allow_merge_commit: false                            # Disable merge commits (keeps history linear)
    allow_rebase_merge: false                            # Disable rebase merge (use squash only)
    delete_branch_on_merge: true                         # Auto-delete head branches after merge
    allow_auto_merge: true                               # Enable auto-merge feature
    allow_update_branch: true                            # Allow updating PR branch with base branch
    squash_merge_commit_title: "COMMIT_OR_PR_TITLE"      # Use commit title or PR title for squash merges
    squash_merge_commit_message: "COMMIT_MESSAGES"       # Include all commit messages in squash merge

  # Repository Features
  # -------------------
  # Controls which GitHub features are enabled
  features:
    has_issues: true                                     # Enable GitHub Issues
    has_wiki: false                                      # Disable Wiki (use docs/ instead)
    has_projects: false                                  # Disable Projects (use GitHub Projects v2 instead)
    has_discussions: false                               # Disable Discussions (enable per-repo if needed)

  # Security Settings
  # -----------------
  # Requires GitHub Advanced Security (GHAS) for private repos
  # Public repos get these features automatically
  security:
    secret_scanning: enabled                             # Scan for exposed secrets
    secret_scanning_push_protection: enabled             # Block pushes with secrets
    dependabot_security_updates: enabled                 # Auto security updates

  # Branch Protection Rules (Legacy)
  # ---------------------------------
  # NOTE: Rulesets (below) are the modern replacement for branch protection.
  # Both coexist during gradual migration. Consider migrating to rulesets.
  branch_protection:
    # Main branch protection
    - pattern: "main"
      required_status_checks:
        strict: true                                     # Require branches to be up to date before merging
        contexts: []                                     # Empty = inherit repo's existing required checks
      required_reviews:
        count: 1                                         # Require 1 approval before merge
        dismiss_stale: true                              # Dismiss approvals when new commits pushed
        require_code_owner_reviews: false
      enforce_admins: false                              # Allow admins to bypass (for emergency fixes)
      require_linear_history: true                       # Prevent merge commits
      allow_force_pushes: false                          # Block force pushes
      allow_deletions: false                             # Block branch deletion
      required_conversation_resolution: true             # Require all review threads resolved

  # Repository Rulesets (Modern)
  # ----------------------------
  # Modern replacement for branch protection with granular targeting and better bypass management.
  # Rulesets provide more flexibility and additional rule types compared to branch protection.
  rulesets:
    # Main branch ruleset
    - name: "main-branch-protection"
      target: "branch"
      enforcement: "active"
      conditions:
        ref_name:
          include:
            - "refs/heads/main"
      bypass_actors:
        # Organization admins can always bypass (for emergency fixes)
        - actor_id: 5                                    # OrganizationAdmin role ID
          actor_type: "OrganizationAdmin"
          bypass_mode: "always"
        # smyklot bot can bypass for automated updates
        - actor_id: 1197525                              # smyklot GitHub App integration ID
          actor_type: "Integration"
          bypass_mode: "exempt"
      rules:
        # Pull request requirements
        pull_request:
          required_approving_review_count: 1
          dismiss_stale_reviews_on_push: true
          require_code_owner_review: true
          require_last_push_approval: true
          required_review_thread_resolution: true
          required_reviewers:
            # Require review from specific teams/users based on file patterns
            # NOTE: Customize per-repo in sync-config.yml or disable if not needed
            - file_patterns: ["*"]
              minimum_approvals: 1
              reviewer:
                id: 15113933                             # smykla-labs/maintainers team ID
                type: "Team"
          allowed_merge_methods:
            - "squash"
        # Required status checks
        required_status_checks:
          strict_required_status_checks_policy: true
          do_not_enforce_on_create: false
          required_status_checks: []                     # Empty = inherit repo's existing checks
          # Example of explicit checks (uncomment and customize per-repo):
          # - context: "Test"
          #   integration_id: 15368                      # GitHub Actions
          # - context: "Lint"
          #   integration_id: 15368
          # - context: "Build (darwin, amd64)"
          #   integration_id: 15368
        # Prevent destructive operations
        deletion: true
        non_fast_forward: true
        # Require commit quality standards
        required_linear_history: true
        required_signatures: true
        # Copilot code review analysis tools
        copilot_code_review_analysis_tools:
          tools:
            - name: "CodeQL"
            - name: "ESLint"
            - name: "PMD"
        # Code scanning requirements
        code_scanning:
          code_scanning_tools:
            - tool: "CodeQL"
              alerts_threshold: "errors"
              security_alerts_threshold: "high_or_higher"
