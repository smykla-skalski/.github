---
name: Sync Files to Repository
description: >-
  Sync files from central repo to target repository, respecting per-repo config

inputs:
  token:
    description: GitHub token for API access
    required: true
  org:
    description: Organization name
    required: true
  repo:
    description: Target repository name
    required: true
  source-repo:
    description: Source repository name (where templates live)
    required: false
    default: .github
  files-config:
    description: JSON array of files to sync [{source, dest}, ...]
    required: true
  sync-config:
    description: Parsed sync-config JSON from get-sync-config action
    required: false
    default: "{}"
  dry-run:
    description: Dry run (no changes)
    required: false
    default: "false"
  branch-prefix:
    description: Prefix for sync branches
    required: false
    default: chore/org-sync
  commit-prefix:
    description: Prefix for commit messages
    required: false
    default: "chore(sync):"
  pr-labels:
    description: Comma-separated labels for PR
    required: false
    default: ci/skip-all

outputs:
  pr-url:
    description: URL of created/updated PR (empty if no changes)
    value: ${{ steps.sync.outputs.pr_url }}
  created:
    description: Number of files created
    value: ${{ steps.sync.outputs.created }}
  updated:
    description: Number of files updated
    value: ${{ steps.sync.outputs.updated }}
  skipped:
    description: Number of files skipped
    value: ${{ steps.sync.outputs.skipped }}
  excluded:
    description: Number of files excluded by config
    value: ${{ steps.sync.outputs.excluded }}

runs:
  using: composite
  steps:
    - name: Sync files
      id: sync
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
        ORG: ${{ inputs.org }}
        REPO: ${{ inputs.repo }}
        SOURCE_REPO: ${{ inputs.source-repo }}
        FILES_CONFIG: ${{ inputs.files-config }}
        SYNC_CONFIG: ${{ inputs.sync-config }}
        DRY_RUN: ${{ inputs.dry-run }}
        BRANCH_PREFIX: ${{ inputs.branch-prefix }}
        COMMIT_PREFIX: ${{ inputs.commit-prefix }}
        PR_LABELS: ${{ inputs.pr-labels }}
        GITHUB_RUN_ID: ${{ github.run_id }}
      run: |
        set -euo pipefail

        echo "ðŸ“ Syncing files to $ORG/$REPO..."

        # Parse sync config
        if [ -n "$SYNC_CONFIG" ] && [ "$SYNC_CONFIG" != "{}" ]; then
          sync_skip=$(echo "$SYNC_CONFIG" | jq -r '.sync.skip // false')
          files_skip=$(echo "$SYNC_CONFIG" | jq -r '.sync.files.skip // false')
          files_exclude=$(echo "$SYNC_CONFIG" | \
            jq -c '.sync.files.exclude // []')
        else
          sync_skip="false"
          files_skip="false"
          files_exclude="[]"
        fi

        # Check skip flags
        if [ "$sync_skip" = "true" ] || [ "$files_skip" = "true" ]; then
          if [ "$sync_skip" = "true" ]; then
            echo "   â­ï¸  Skipping: sync.skip=true in repo config"
            skip_reason="File synchronization is disabled for this repository (sync.skip=true)"
          else
            echo "   â­ï¸  Skipping: files.skip=true in repo config"
            skip_reason="File synchronization is disabled for this repository (files.skip=true)"
          fi

          # Check if there's an existing PR to close
          repo_sanitized="${REPO#.}"
          branch_name="${BRANCH_PREFIX}/${repo_sanitized}"
          existing_pr=$(gh pr list --repo "$ORG/$REPO" \
            --head "$branch_name" \
            --state open \
            --json number \
            --jq '.[0].number') || existing_pr=""

          if [ -n "$existing_pr" ] && [ "$existing_pr" != "null" ]; then
            echo "   Closing PR #$existing_pr (file sync disabled)"
            gh pr close "$existing_pr" \
              --repo "$ORG/$REPO" \
              --comment "$skip_reason" \
              2>&1 || true
          fi

          echo "pr_url=" >> "$GITHUB_OUTPUT"
          echo "created=0" >> "$GITHUB_OUTPUT"
          echo "updated=0" >> "$GITHUB_OUTPUT"
          echo "skipped=0" >> "$GITHUB_OUTPUT"
          echo "excluded=0" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "   Excluded files: $files_exclude"

        # Parse files config
        files=$(echo "$FILES_CONFIG" | jq -c '.[]')

        # Track changes
        created=0
        updated=0
        skipped=0
        excluded=0
        changes=()
        created_files=()
        updated_files=()

        # Get default branch for target repo
        default_branch=$(gh api "repos/$ORG/$REPO" --jq '.default_branch')
        echo "   Default branch: $default_branch"

        # Get current HEAD SHA for the default branch
        base_sha=$(gh api "repos/$ORG/$REPO/git/ref/heads/$default_branch" \
          --jq '.object.sha')
        echo "   Base SHA: ${base_sha:0:7}"

        # Process each file
        while IFS= read -r file_entry; do
          [ -z "$file_entry" ] && continue

          source_path=$(echo "$file_entry" | jq -r '.source')
          dest_path=$(echo "$file_entry" | jq -r '.dest')

          echo ""
          echo "   ðŸ“„ Processing: $dest_path"

          # Check if file is excluded
          if echo "$files_exclude" | jq -e --arg f "$dest_path" \
              'map(. == $f) | any' > /dev/null 2>&1; then
            echo "      â­ï¸  Excluded by config"
            excluded=$((excluded + 1))
            continue
          fi

          # Fetch source file from central repo
          api_path="repos/$ORG/$SOURCE_REPO/contents/$source_path"
          source_response=$(gh api "$api_path" 2>&1) || true

          if ! echo "$source_response" | jq -e '.content' > /dev/null 2>&1; then
            echo "      âŒ Source not found: $source_path"
            continue
          fi

          source_content=$(echo "$source_response" | \
            jq -r '.content' | base64 -d)
          source_sha=$(echo "$source_response" | jq -r '.sha')

          # Fetch target file from target repo
          target_response=$(gh api "repos/$ORG/$REPO/contents/$dest_path" \
            2>&1) || true

          if echo "$target_response" | jq -e '.content' > /dev/null 2>&1; then
            # File exists - check if update needed
            target_content=$(echo "$target_response" | \
              jq -r '.content' | base64 -d)
            target_sha=$(echo "$target_response" | jq -r '.sha')

            if [ "$source_content" = "$target_content" ]; then
              echo "      âœ“ Already up to date"
              skipped=$((skipped + 1))
              continue
            fi

            echo "      ðŸ”„ Needs update"
            action="update"
            updated=$((updated + 1))
            updated_files+=("$dest_path")
          else
            # File doesn't exist - create
            echo "      ðŸ†• Will create"
            action="create"
            target_sha=""
            created=$((created + 1))
            created_files+=("$dest_path")
          fi

          # Stage change for batch commit
          # Encode content as base64 for later use (preserve trailing newline)
          encoded_content=$(echo "$source_content" | base64 | tr -d '\n')
          changes+=("$(jq -n \
            --arg path "$dest_path" \
            --arg content "$encoded_content" \
            --arg action "$action" \
            --arg sha "$target_sha" \
            '{path: $path, content: $content, action: $action, sha: $sha}')")
        done <<< "$files"

        echo ""
        echo "ðŸ“Š Summary:"
        echo "   Created: $created"
        echo "   Updated: $updated"
        echo "   Skipped: $skipped (already up to date)"
        echo "   Excluded: $excluded (by repo config)"

        # Output counts
        echo "created=$created" >> "$GITHUB_OUTPUT"
        echo "updated=$updated" >> "$GITHUB_OUTPUT"
        echo "skipped=$skipped" >> "$GITHUB_OUTPUT"
        echo "excluded=$excluded" >> "$GITHUB_OUTPUT"

        # If no changes, check for existing PR and close it
        if [ ${#changes[@]} -eq 0 ]; then
          echo ""
          echo "âœ… No changes needed"

          # Check if there's an existing PR to close
          repo_sanitized="${REPO#.}"
          branch_name="${BRANCH_PREFIX}/${repo_sanitized}"
          existing_pr=$(gh pr list --repo "$ORG/$REPO" \
            --head "$branch_name" \
            --state open \
            --json number \
            --jq '.[0].number') || existing_pr=""

          if [ -n "$existing_pr" ] && [ "$existing_pr" != "null" ]; then
            echo "   Closing PR #$existing_pr (files are now in sync)"
            gh pr close "$existing_pr" \
              --repo "$ORG/$REPO" \
              --comment "All files are now in sync. Closing this PR." \
              2>&1 || true
          fi

          echo "pr_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        if [ "$DRY_RUN" = "true" ]; then
          echo ""
          echo "ðŸ” Dry run - no changes made"
          echo "pr_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo ""
        echo "ðŸ”§ Creating PR with changes..."

        # Branch name - sanitize repo name (strip leading dots)
        repo_sanitized="${REPO#.}"
        branch_name="${BRANCH_PREFIX}/${repo_sanitized}"

        # Check if branch exists
        existing_branch=$(gh api "repos/$ORG/$REPO/git/ref/heads/$branch_name" \
          2>&1) || true

        if echo "$existing_branch" | jq -e '.object.sha' > /dev/null 2>&1; then
          echo "   Branch exists, will override commits..."
        else
          echo "   Creating branch: $branch_name"
          # Create branch from default branch HEAD
          gh api "repos/$ORG/$REPO/git/refs" \
            -f ref="refs/heads/$branch_name" \
            -f sha="$base_sha" > /dev/null
        fi

        # Always start from base to override previous commits
        current_sha="$base_sha"

        for change_json in "${changes[@]}"; do
          file_path=$(echo "$change_json" | jq -r '.path')
          encoded=$(echo "$change_json" | jq -r '.content')
          action=$(echo "$change_json" | jq -r '.action')

          echo "   Committing: $file_path"

          # Create blob
          blob_sha=$(gh api "repos/$ORG/$REPO/git/blobs" \
            -f content="$encoded" \
            -f encoding="base64" \
            --jq '.sha')

          # Get current tree
          current_tree=$(gh api "repos/$ORG/$REPO/git/commits/$current_sha" \
            --jq '.tree.sha')

          # Create new tree with file
          tree_json=$(jq -n \
            --arg base "$current_tree" \
            --arg path "$file_path" \
            --arg blob "$blob_sha" \
            '{
              base_tree: $base,
              tree: [{
                path: $path,
                mode: "100644",
                type: "blob",
                sha: $blob
              }]
            }')
          new_tree=$(echo "$tree_json" | \
            gh api "repos/$ORG/$REPO/git/trees" --input - --jq '.sha')

          # Create commit
          commit_msg="$COMMIT_PREFIX $action $file_path"
          new_commit=$(gh api "repos/$ORG/$REPO/git/commits" \
            --input <(jq -n \
              --arg msg "$commit_msg" \
              --arg tree "$new_tree" \
              --arg parent "$current_sha" \
              '{message: $msg, tree: $tree, parents: [$parent]}') \
            --jq '.sha')

          current_sha="$new_commit"
        done

        # Update branch ref (force-with-lease to override previous commits)
        gh api "repos/$ORG/$REPO/git/refs/heads/$branch_name" \
          -X PATCH \
          -f sha="$current_sha" \
          -F force=true > /dev/null

        echo "   Branch updated to: ${current_sha:0:7}"

        # Build PR title and body (used for both create and update)
        pr_title="chore(sync): sync organization files"

        # Build file lists for PR body
        created_list=""
        if [ ${#created_files[@]} -gt 0 ]; then
          for file in "${created_files[@]}"; do
            created_list="${created_list}- \`${file}\`"$'\n'
          done
        else
          created_list="- None"$'\n'
        fi

        updated_list=""
        if [ ${#updated_files[@]} -gt 0 ]; then
          for file in "${updated_files[@]}"; do
            updated_list="${updated_list}- \`${file}\`"$'\n'
          done
        else
          updated_list="- None"$'\n'
        fi

        # Build PR body
        run_url="https://github.com/$ORG/$SOURCE_REPO/actions/runs/${GITHUB_RUN_ID}"
        pr_body="Syncs organization files from [\`$ORG/$SOURCE_REPO\`](https://github.com/$ORG/$SOURCE_REPO)."
        pr_body="${pr_body}"$'\n\n'"## Files Created"$'\n\n'"${created_list}"
        pr_body="${pr_body}"$'\n'"## Files Updated"$'\n\n'"${updated_list}"
        pr_body="${pr_body}"$'\n'"---"$'\n\n'
        pr_body="${pr_body}*This PR was automatically created by the org file sync workflow "
        pr_body="${pr_body}(run [#${GITHUB_RUN_ID}](${run_url}))*"

        # Check for existing PR
        existing_pr=$(gh pr list --repo "$ORG/$REPO" \
          --head "$branch_name" \
          --state open \
          --json number,url \
          --jq '.[0]') || existing_pr=""

        if [ -n "$existing_pr" ] && [ "$existing_pr" != "null" ]; then
          # Update existing PR
          pr_number=$(echo "$existing_pr" | jq -r '.number')
          pr_url=$(echo "$existing_pr" | jq -r '.url')

          # Parse labels for update
          IFS=',' read -ra label_array <<< "$PR_LABELS"
          label_args=()
          for label in "${label_array[@]}"; do
            label_args+=(--add-label "$label")
          done

          gh pr edit "$pr_number" \
            --repo "$ORG/$REPO" \
            --title "$pr_title" \
            --body "$pr_body" \
            "${label_args[@]}" 2>&1 || true

          echo "   Updated existing PR: $pr_url"
        else

          # Parse labels
          IFS=',' read -ra label_array <<< "$PR_LABELS"
          label_args=()
          for label in "${label_array[@]}"; do
            label_args+=(--label "$label")
          done

          pr_url=$(gh pr create \
            --repo "$ORG/$REPO" \
            --head "$branch_name" \
            --base "$default_branch" \
            --title "$pr_title" \
            --body "$pr_body" \
            "${label_args[@]}" \
            2>&1) || pr_url=""

          if [ -n "$pr_url" ]; then
            echo "   Created PR: $pr_url"
          else
            echo "   âŒ Failed to create PR"
          fi
        fi

        echo "pr_url=$pr_url" >> "$GITHUB_OUTPUT"
        echo ""
        echo "âœ… File sync complete"
