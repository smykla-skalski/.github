---
name: Sync Labels to Repository
description: >-
  Sync labels from central config to target repository using GitHub CLI

inputs:
  token:
    description: GitHub token for API access
    required: true
  org:
    description: Organization name
    required: true
  repo:
    description: Repository name
    required: true
  labels-file:
    description: Path to labels YAML file
    required: true
    default: .github/labels.yml
  sync-config:
    description: JSON sync config from get-sync-config action
    required: false
    default: "{}"
  dry-run:
    description: Dry run (no changes)
    required: false
    default: "false"

runs:
  using: composite
  steps:
    - name: Sync labels
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
        ORG: ${{ inputs.org }}
        REPO: ${{ inputs.repo }}
        LABELS_FILE: ${{ inputs.labels-file }}
        SYNC_CONFIG: ${{ inputs.sync-config }}
        DRY_RUN: ${{ inputs.dry-run }}
      run: |
        # Parse sync config
        if [ -n "$SYNC_CONFIG" ] && [ "$SYNC_CONFIG" != "{}" ]; then
          global_skip=$(echo "$SYNC_CONFIG" | jq -r '.sync.skip // false')
          labels_skip=$(echo "$SYNC_CONFIG" | \
            jq -r '.sync.labels.skip // false')
          labels_exclude=$(echo "$SYNC_CONFIG" | \
            jq -c '.sync.labels.exclude // []')
          allow_removal=$(echo "$SYNC_CONFIG" | \
            jq -r '.sync.labels.allow_removal // false')
        else
          global_skip="false"
          labels_skip="false"
          labels_exclude="[]"
          allow_removal="false"
        fi

        # Check skip conditions
        if [ "$global_skip" = "true" ]; then
          echo "â­ï¸  Skipping $REPO: global sync.skip=true"
          echo "## $REPO" >> "$GITHUB_STEP_SUMMARY"
          echo "â­ï¸ Skipped (global sync.skip=true)" >> "$GITHUB_STEP_SUMMARY"
          exit 0
        fi

        if [ "$labels_skip" = "true" ]; then
          echo "â­ï¸  Skipping $REPO: sync.labels.skip=true"
          echo "## $REPO" >> "$GITHUB_STEP_SUMMARY"
          msg="â­ï¸ Skipped (sync.labels.skip=true)"
          echo "$msg" >> "$GITHUB_STEP_SUMMARY"
          exit 0
        fi

        # Parse desired labels from config
        desired=$(yq eval -o json '.[]' "$LABELS_FILE" | jq -s '.')

        # Filter out excluded labels
        if [ "$labels_exclude" != "[]" ]; then
          exclude_count=$(echo "$labels_exclude" | jq 'length')
          echo "ğŸ“‹ Excluding $exclude_count labels from sync"
          desired=$(echo "$desired" | \
            jq --argjson exclude "$labels_exclude" \
            '[.[] | select(.name as $n | $exclude | index($n) | not)]')
        fi

        # Get current labels from target repo
        jq_filter='.[] | {name, color, description: (.description // "")}'
        current=$(gh api "repos/$ORG/$REPO/labels" --paginate \
          --jq "$jq_filter" | jq -s '.')

        echo "ğŸ“‹ Processing labels for $REPO..."
        echo "   Desired: $(echo "$desired" | jq 'length') labels"
        echo "   Current: $(echo "$current" | jq 'length') labels"
        echo "   Allow removal: $allow_removal"

        # Build maps for efficient lookup
        map_transform='map({(.name): {color, description}}) | add // {}'
        desired_map=$(echo "$desired" | jq "$map_transform")
        current_map=$(echo "$current" | jq "$map_transform")

        # Get label names
        desired_names=$(echo "$desired" | jq -r '.[].name')
        current_names=$(echo "$current" | jq -r '.[].name')

        # Track changes
        created=0
        updated=0
        removed=0
        skipped=0

        # Process creates and updates
        while IFS= read -r name; do
          [ -z "$name" ] && continue

          color=$(echo "$desired_map" | \
            jq -r --arg n "$name" '.[$n].color' | sed 's/^#//')
          description=$(echo "$desired_map" | \
            jq -r --arg n "$name" '.[$n].description')

          if ! echo "$current_names" | grep -qxF "$name"; then
            # Create new label
            if [ "$DRY_RUN" = "true" ]; then
              echo "ğŸ†• Would create: $name"
              created=$((created + 1))
            else
              if gh api "repos/$ORG/$REPO/labels" \
                -f name="$name" \
                -f color="$color" \
                -f description="$description" > /dev/null 2>&1; then
                echo "âœ… Created: $name"
                created=$((created + 1))
              else
                echo "âŒ Failed to create: $name"
              fi
            fi
          else
            # Check if update needed
            current_color=$(echo "$current_map" | \
              jq -r --arg n "$name" '.[$n].color' | sed 's/^#//')
            current_desc=$(echo "$current_map" | \
              jq -r --arg n "$name" '.[$n].description')

            need_update=false
            if [ "$current_color" != "$color" ]; then
              need_update=true
            elif [ "$current_desc" != "$description" ]; then
              need_update=true
            fi

            if [ "$need_update" = "true" ]; then
              if [ "$DRY_RUN" = "true" ]; then
                echo "ğŸ”„ Would update: $name"
                updated=$((updated + 1))
              else
                # URL-encode label name for API path
                encoded_name=$(printf '%s' "$name" | jq -sRr @uri)
                api_path="repos/$ORG/$REPO/labels/$encoded_name"
                if gh api "$api_path" \
                  -X PATCH \
                  -f color="$color" \
                  -f description="$description" > /dev/null 2>&1; then
                  echo "ğŸ”„ Updated: $name"
                  updated=$((updated + 1))
                else
                  echo "âŒ Failed to update: $name"
                fi
              fi
            else
              skipped=$((skipped + 1))
            fi
          fi
        done <<< "$desired_names"

        # Process removals if allowed
        if [ "$allow_removal" = "true" ]; then
          echo ""
          echo "ğŸ—‘ï¸  Checking for labels to remove..."

          # Get list of labels to remove (in current but not in desired)
          desired_names_json=$(echo "$desired" | jq -c '[.[].name]')

          while IFS= read -r name; do
            [ -z "$name" ] && continue

            # Check if this label is in the desired list
            in_desired=$(echo "$desired_names_json" | \
              jq -e --arg n "$name" 'index($n)' 2>/dev/null) || in_desired=""
            if [ -z "$in_desired" ]; then
              if [ "$DRY_RUN" = "true" ]; then
                echo "ğŸ—‘ï¸  Would remove: $name"
                removed=$((removed + 1))
              else
                # URL-encode label name for API path
                encoded_name=$(printf '%s' "$name" | jq -sRr @uri)
                api_path="repos/$ORG/$REPO/labels/$encoded_name"
                if gh api "$api_path" -X DELETE > /dev/null 2>&1; then
                  echo "ğŸ—‘ï¸  Removed: $name"
                  removed=$((removed + 1))
                else
                  echo "âŒ Failed to remove: $name"
                fi
              fi
            fi
          done <<< "$current_names"
        fi

        echo ""
        echo "ğŸ“Š Summary for $REPO:"
        echo "   Created: $created"
        echo "   Updated: $updated"
        echo "   Removed: $removed"
        echo "   Skipped: $skipped (already up to date)"
        echo "âœ… Label sync complete"

        # Write to GITHUB_STEP_SUMMARY
        {
          echo "## $REPO"
          echo ""
          if [ "$DRY_RUN" = "true" ]; then
            echo "**Mode:** Dry run (no changes made)"
            echo ""
          fi
          echo "| Action | Count |"
          echo "|--------|-------|"
          echo "| âœ… Created | $created |"
          echo "| ğŸ”„ Updated | $updated |"
          echo "| ğŸ—‘ï¸ Removed | $removed |"
          echo "| â­ï¸ Skipped | $skipped |"
          echo ""
        } >> "$GITHUB_STEP_SUMMARY"
